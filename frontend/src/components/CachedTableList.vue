<template>
  <div class="cached-table-list">
    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="toolbar">
      <div class="toolbar-left">
        <el-input
          v-model="searchText"
          placeholder="ÊêúÁ¥¢Ë°®Âêç..."
          :prefix-icon="Search"
          clearable
          @input="handleSearch"
          @clear="handleSearch"
          class="search-input"
        />
      </div>
      
      <div class="toolbar-right">
        <el-tooltip content="Âà∑Êñ∞Ë°®Êï∞ÊçÆ" placement="top">
          <el-button
            :icon="Refresh"
            :loading="refreshing"
            @click="refreshTables"
            size="small"
            type="primary"
            plain
          >
            Âà∑Êñ∞
          </el-button>
        </el-tooltip>
        
        <el-tooltip content="ÁºìÂ≠òÁä∂ÊÄÅ" placement="top">
          <el-tag
            :type="cacheStatus.type"
            size="small"
            class="cache-status"
          >
            {{ cacheStatus.text }}
          </el-tag>
        </el-tooltip>
      </div>
    </div>

    <!-- ÁºìÂ≠ò‰ø°ÊÅØ -->
    <div class="cache-info" v-if="cacheMetadata">
      <el-text size="small" type="info">
        <el-icon><Clock /></el-icon>
        ÊúÄÂêéÊõ¥Êñ∞Ôºö{{ formatTime(cacheMetadata.lastUpdated) }}
        (ÂÖ± {{ cacheMetadata.totalCount }} Âº†Ë°®)
      </el-text>
    </div>

    <!-- Ë°®Ê†ºÂÆπÂô® -->
    <div class="table-container" ref="containerRef">
      <el-auto-resizer>
        <template #default="{ height, width }">
          <el-table-v2
            :key="tableKey"
            :columns="columns"
            :data="displayData"
            :width="width"
            :height="height"
            :row-height="68"
            :header-height="48"
            :estimated-row-height="68"
            :row-class="getRowClass"
            class="virtual-table"
          >
            <template #empty>
              <el-empty 
                :description="getEmptyDescription()"
                :image-size="100"
              >
                <template #default>
                  <div class="empty-actions" v-if="!loading && !hasCache">
                    <el-button 
                      type="primary" 
                      @click="refreshTables"
                      :loading="refreshing"
                    >
                      Âä†ËΩΩË°®Êï∞ÊçÆ
                    </el-button>
                  </div>
                </template>
              </el-empty>
            </template>
          </el-table-v2>
        </template>
      </el-auto-resizer>
    </div>

    <!-- ËØ¶ÁªÜÂä†ËΩΩÁä∂ÊÄÅ -->
    <div class="loading-overlay" v-if="loading">
      <div class="loading-content">
        <el-skeleton v-if="!showDetailedProgress" :rows="5" animated />
        
        <!-- ËØ¶ÁªÜËøõÂ∫¶ÊòæÁ§∫ -->
        <div v-else class="detailed-loading">
          <div class="loading-header">
            <el-icon class="loading-icon" size="24">
              <Loading />
            </el-icon>
            <h3 class="loading-title">{{ loadingStage }}</h3>
          </div>
          
          <div class="loading-body">
            <el-progress 
              v-if="estimatedTotal > 0"
              :percentage="loadingProgress" 
              :stroke-width="8"
              status="success"
              striped
              striped-flow
            >
              <template #default="{ percentage }">
                <span class="progress-text">{{ percentage }}%</span>
              </template>
            </el-progress>
            
            <div class="loading-details" v-if="loadingDetails">
              {{ loadingDetails }}
            </div>
            
            <div class="loading-stats" v-if="loadedCount > 0 || estimatedTotal > 0">
              <span>Â∑≤Âä†ËΩΩÔºö{{ loadedCount }}</span>
              <span v-if="estimatedTotal > 0">/ {{ estimatedTotal }} Âº†Ë°®</span>
            </div>
          </div>
          
          <div class="loading-tips">
            <el-text size="small" type="info">
              üí° È¶ñÊ¨°Âä†ËΩΩËæÉÊÖ¢ÔºåÂêéÁª≠ËÆøÈóÆÂ∞Ü‰ΩøÁî®ÁºìÂ≠òÂø´ÈÄüÂìçÂ∫î
            </el-text>
          </div>
        </div>
      </div>
    </div>

    <!-- Âè≥ÈîÆËèúÂçï -->
    <div v-if="showContextMenu" class="context-menu-overlay" @click="hideContextMenu">
      <div class="context-menu" :style="contextMenuStyle" @click.stop>
        <div class="context-menu-item" @click.stop="handleContextMenuCommand('select')">
          <el-icon><Search /></el-icon>
          SELECT Êü•ËØ¢
        </div>
        <div class="context-menu-item" @click.stop="handleContextMenuCommand('count')">
          <el-icon><Document /></el-icon>
          COUNT Êü•ËØ¢
        </div>
        <div class="context-menu-item" @click.stop="handleContextMenuCommand('describe')">
          <el-icon><View /></el-icon>
          Ë°®ÁªìÊûÑ
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" @click.stop="handleContextMenuCommand('insert')">
          <el-icon><Document /></el-icon>
          INSERT Ê®°Êùø
        </div>
        <div class="context-menu-item" @click.stop="handleContextMenuCommand('update')">
          <el-icon><Document /></el-icon>
          UPDATE Ê®°Êùø
        </div>
        <div class="context-menu-item" @click.stop="handleContextMenuCommand('delete')">
          <el-icon><Document /></el-icon>
          DELETE Ê®°Êùø
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" @click.stop="handleContextMenuCommand('viewFields')">
          <el-icon><View /></el-icon>
          Êü•ÁúãÂ≠óÊÆµ
        </div>
      </div>
    </div>

    <!-- SQL ËèúÂçï -->
    <div v-if="showSqlMenu" class="sql-menu-overlay" @click="hideSqlMenu">
      <div class="sql-menu" :style="sqlMenuStyle" @click.stop>
        <div class="sql-menu-item" @click="handleSqlMenuCommand('select')">
          <el-icon><Search /></el-icon>
          SELECT Êü•ËØ¢
        </div>
        <div class="sql-menu-item" @click="handleSqlMenuCommand('count')">
          <el-icon><Document /></el-icon>
          COUNT Êü•ËØ¢
        </div>
        <div class="sql-menu-item" @click="handleSqlMenuCommand('describe')">
          <el-icon><View /></el-icon>
          Ë°®ÁªìÊûÑ
        </div>
        <div class="sql-menu-divider"></div>
        <div class="sql-menu-item" @click="handleSqlMenuCommand('insert')">
          <el-icon><Document /></el-icon>
          INSERT Ê®°Êùø
        </div>
        <div class="sql-menu-item" @click="handleSqlMenuCommand('update')">
          <el-icon><Document /></el-icon>
          UPDATE Ê®°Êùø
        </div>
        <div class="sql-menu-item" @click="handleSqlMenuCommand('delete')">
          <el-icon><Document /></el-icon>
          DELETE Ê®°Êùø
        </div>
      </div>
    </div>

    <!-- Â≠óÊÆµÂàóË°®ÂºπÊ°Ü -->
    <el-dialog
      v-model="showFieldDialog"
      :title="dialogTitle"
      width="900px"
      :close-on-click-modal="false"
      class="field-dialog"
    >
      <div class="field-dialog-header">
        <el-input
          v-model="fieldSearchText"
          placeholder="ÊêúÁ¥¢Â≠óÊÆµÂêç..."
          :prefix-icon="Search"
          clearable
          class="field-search"
        />
        <div class="field-stats">
          <el-tag type="info" size="small">
            ÂÖ± {{ filteredFields.length }} ‰∏™Â≠óÊÆµ
          </el-tag>
        </div>
      </div>
      
      <div class="field-dialog-content">
        <el-table
          :data="filteredFields"
          v-loading="fieldDialogLoading"
          stripe
          border
          height="450"
          class="field-table"
        >
          <el-table-column prop="columnName" label="Â≠óÊÆµÂêç" width="160">
            <template #default="{ row }">
              <div class="field-name-cell">
                <el-icon v-if="row.isPrimaryKey" class="pk-icon"><Key /></el-icon>
                <span class="field-name" :class="{ 'is-primary': row.isPrimaryKey }">
                  {{ row.columnName }}
                </span>
                <el-button
                  size="small"
                  text
                  :icon="CopyDocument"
                  @click="copyFieldName(row.columnName)"
                  class="copy-btn"
                />
              </div>
            </template>
          </el-table-column>
          <el-table-column prop="dataType" label="Á±ªÂûã" width="120">
            <template #default="{ row }">
              <el-tag size="small" class="type-tag">{{ row.dataType }}</el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="columnSize" label="ÈïøÂ∫¶" width="80" align="center" />
          <el-table-column prop="nullable" label="ÂèØÁ©∫" width="80" align="center">
            <template #default="{ row }">
              <el-tag :type="row.nullable ? 'success' : 'danger'" size="small">
                {{ row.nullable ? 'ÊòØ' : 'Âê¶' }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="isPrimaryKey" label="‰∏ªÈîÆ" width="80" align="center">
            <template #default="{ row }">
              <el-tag v-if="row.isPrimaryKey" type="warning" size="small">
                <el-icon><Key /></el-icon>
                ‰∏ªÈîÆ
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="isAutoIncrement" label="Ëá™Â¢û" width="80" align="center">
            <template #default="{ row }">
              <el-tag v-if="row.isAutoIncrement" type="info" size="small">Ëá™Â¢û</el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="remarks" label="Â§áÊ≥®" min-width="150">
            <template #default="{ row }">
              <span class="field-remarks">{{ row.remarks || '-' }}</span>
            </template>
          </el-table-column>
        </el-table>
      </div>
      
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="copyAllFields" :icon="CopyDocument">
            Â§çÂà∂ÊâÄÊúâÂ≠óÊÆµÂêç
          </el-button>
          <el-button @click="showFieldDialog = false" type="primary">
            ÂÖ≥Èó≠
          </el-button>
        </div>
      </template>
    </el-dialog>

  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, nextTick, watch, h } from 'vue'
import { ElMessage, ElIcon, ElTag, ElText, ElTooltip, ElButton } from 'element-plus'
import { Search, Refresh, Clock, Document, View, Close, Key, CopyDocument, Loading } from '@element-plus/icons-vue'
import { tableCacheManager, type TableInfo, type CacheMetadata } from '@/utils/TableCacheManager'
import { getTablesWithPaginationApi, getTableColumnsApi, getBasicTablesApi, getBasicTablesWithPaginationApi, getTableDetailsApi, getBatchTableStatsApi, getConnectionByIdApi } from '@/api/database'
import { generateSelectQuery, generateInsertQuery, generateUpdateQuery, generateDeleteQuery, generateDescribeQuery, getPaginationSyntaxInfo } from '@/utils/SqlGenerator'

// Props
interface Props {
  connectionId: string
  schema?: string
}

const props = defineProps<Props>()

// Emits
interface Emits {
  (e: 'table-click', tableName: string): void
  (e: 'sql-generated', sql: string): void
}

const emit = defineEmits<Emits>()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const searchText = ref('')
const loading = ref(false)
const refreshing = ref(false)
const tableData = ref<TableInfo[]>([])
const filteredData = ref<TableInfo[]>([])
const cacheMetadata = ref<CacheMetadata | null>(null)
const tableKey = ref(0) // Áî®‰∫éÂº∫Âà∂ÈáçÊñ∞Ê∏≤ÊüìË°®Ê†º

// Êñ∞Â¢ûÔºöËØ¶ÁªÜÁöÑÂä†ËΩΩÁä∂ÊÄÅÁÆ°ÁêÜ
const loadingProgress = ref(0)
const loadingStage = ref('')
const loadingDetails = ref('')
const showDetailedProgress = ref(false)
const estimatedTotal = ref(0)
const loadedCount = ref(0)

// Êï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ
const connectionInfo = ref<any>(null)
const dbType = ref('')

// SQL ËèúÂçïÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showSqlMenu = ref(false)
const sqlMenuStyle = ref({})
const sqlMenuTable = ref<TableInfo | null>(null)

// Âè≥ÈîÆËèúÂçïÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showContextMenu = ref(false)
const contextMenuStyle = ref({})
const contextMenuTable = ref<TableInfo | null>(null)

// Â≠óÊÆµÂºπÊ°ÜÁõ∏ÂÖ≥Áä∂ÊÄÅ
const showFieldDialog = ref(false)
const fieldDialogLoading = ref(false)
const tableFields = ref<any[]>([])
const dialogTitle = ref('')
const fieldSearchText = ref('')

// ÊêúÁ¥¢Èò≤Êäñ
const searchTimeout = ref<any>(null)

// ÂÆπÂô®ÂºïÁî®
const containerRef = ref()

// ËÆ°ÁÆóÂ±ûÊÄßÔºöËøáÊª§ÂêéÁöÑÂ≠óÊÆµÂàóË°®
const filteredFields = computed(() => {
  if (!fieldSearchText.value.trim()) {
    return tableFields.value
  }
  
  const searchLower = fieldSearchText.value.toLowerCase()
  return tableFields.value.filter(field => 
    field.columnName.toLowerCase().includes(searchLower) ||
    (field.remarks && field.remarks.toLowerCase().includes(searchLower))
  )
})

// ËÆ°ÁÆóÂ±ûÊÄß
const displayData = computed(() => filteredData.value)

const hasCache = computed(() => {
  return tableCacheManager.hasCache(props.connectionId, props.schema)
})

const cacheStatus = computed(() => {
  if (!hasCache.value) {
    return { type: 'info' as const, text: 'Êó†ÁºìÂ≠ò' }
  }
  
  if (cacheMetadata.value) {
    const age = Date.now() - cacheMetadata.value.lastUpdated
    const hours = Math.floor(age / (1000 * 60 * 60))
    
    if (hours < 1) {
      return { type: 'success' as const, text: 'ÊúÄÊñ∞' }
    } else if (hours < 12) {
      return { type: 'warning' as const, text: `${hours}Â∞èÊó∂Ââç` }
    } else {
      return { type: 'danger' as const, text: 'ËæÉÊóß' }
    }
  }
  
  return { type: 'info' as const, text: 'Â∑≤ÁºìÂ≠ò' }
})

// Ë°®Ê†ºÂàóÂÆö‰πâ - ÁÆÄÂåñ‰∏∫ÊôÆÈÄöÂ±ïÁ§∫Ê®°Âºè
const columns = computed(() => [
  {
    key: 'tableName',
    title: 'Ë°®Âêç',
    dataKey: 'tableName',
    width: 350,
    cellRenderer: ({ rowData }: any) => {
      // Áªü‰∏ÄÁöÑË°®ÂêçÊòæÁ§∫ÔºåÂ∏¶ËØ¶ÁªÜ tooltip
      const tooltipContent = h('div', { class: 'tooltip-content' }, [
        h('div', { class: 'tooltip-item' }, [
          h('span', { class: 'tooltip-label' }, 'Á±ªÂûãÔºö'),
          h('span', { class: 'tooltip-value' }, rowData.tableType === 'VIEW' ? 'ËßÜÂõæ' : 'Êï∞ÊçÆË°®')
        ]),
        h('div', { class: 'tooltip-item' }, [
          h('span', { class: 'tooltip-label' }, 'Â≠óÊÆµÊï∞Ôºö'),
          h('span', { class: 'tooltip-value' }, `${rowData.columnCount || 0} ‰∏™`)
        ]),
        h('div', { class: 'tooltip-item' }, [
          h('span', { class: 'tooltip-label' }, '‰∏ªÈîÆÔºö'),
          h('span', { class: 'tooltip-value' }, rowData.hasPrimaryKey ? 'Êúâ' : 'Êó†')
        ]),
        rowData.remarks ? h('div', { class: 'tooltip-item' }, [
          h('span', { class: 'tooltip-label' }, 'Â§áÊ≥®Ôºö'),
          h('span', { class: 'tooltip-value' }, rowData.remarks)
        ]) : null
      ].filter(Boolean))
      
      return h(ElTooltip, {
        placement: 'right',
        showAfter: 300,
        hideAfter: 100,
        popperClass: 'table-info-tooltip'
      }, {
        content: () => tooltipContent,
        default: () => h('div', { 
          class: 'table-row-cell full-width-cell',
          'data-table-name': rowData.tableName,
          style: { width: '100%', minHeight: '68px' },
          onContextmenu: (e: MouseEvent) => {
            e.preventDefault()
            e.stopPropagation()
            handleRowContextMenu(e, rowData)
          }
        }, [
          h('div', { class: 'table-name-content' }, [
            h('span', { class: 'table-name' }, rowData.tableName),
            h('div', { class: 'table-meta-tags' }, [
              h(ElTag, { 
                size: 'small', 
                type: rowData.tableType === 'VIEW' ? 'info' : 'success',
                class: 'table-type-tag'
              }, () => rowData.tableType === 'VIEW' ? 'ËßÜÂõæ' : 'Ë°®'),
              h('span', { class: 'column-count' }, `${rowData.columnCount || 0}Âàó`),
              rowData.hasPrimaryKey ? h(ElTag, { 
                size: 'small', 
                type: 'warning',
                class: 'pk-tag'
              }, () => 'PK') : null
            ].filter(Boolean))
          ])
        ])
      })
    }
  },
  {
    key: 'remarks',
    title: 'Â§áÊ≥®',
    dataKey: 'remarks',
    width: 200,
    cellRenderer: ({ rowData }: any) => {
      const remarks = rowData.remarks || '-'
      return h('div', { 
        class: 'table-row-cell table-remarks-cell full-width-cell',
        style: { width: '100%', minHeight: '68px' },
        onContextmenu: (e: MouseEvent) => {
          e.preventDefault()
          e.stopPropagation()
          handleRowContextMenu(e, rowData)
        }
      }, [
        h('span', {
          class: 'table-remarks',
          title: remarks.length > 30 ? remarks : undefined
        }, remarks.length > 30 ? `${remarks.substring(0, 30)}...` : remarks)
      ])
    }
  }
])

// ÊñπÊ≥ï - ÁßªÈô§‰∫ÜÂ∑¶ÈîÆÁÇπÂáªÈÄâ‰∏≠ÈÄªËæë

// Êü•ÁúãÂ≠óÊÆµÂäüËÉΩ
const handleViewFields = async (table: TableInfo) => {
  dialogTitle.value = `${table.tableName}${table.remarks ? ` - ${table.remarks}` : ''}`
  showFieldDialog.value = true
  fieldDialogLoading.value = true
  
  try {
    const fields = await getTableColumnsApi(props.connectionId, table.tableName, props.schema)
    tableFields.value = fields
  } catch (error: any) {
    ElMessage.error('Ëé∑ÂèñÂ≠óÊÆµ‰ø°ÊÅØÂ§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'))
    tableFields.value = []
  } finally {
    fieldDialogLoading.value = false
  }
}


// Â§ÑÁêÜ SQL ÂëΩ‰ª§
const handleSqlCommand = async (command: string, table: TableInfo) => {
  if (!table || !table.tableName) {
    console.error('Invalid table object:', table)
    ElMessage.error('Ë°®‰ø°ÊÅØÊó†ÊïàÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©')
    return
  }
  
  let sql = ''
  try {
    switch (command) {
      case 'select':
        sql = await generateSelectSql(table.tableName)
        break
      case 'count':
        sql = `SELECT COUNT(*) FROM ${table.tableName};`
        break
      case 'describe':
        sql = await generateDescribeSql(table.tableName)
        break
      case 'insert':
        sql = await generateInsertSql(table.tableName)
        break
      case 'update':
        sql = await generateUpdateSql(table.tableName)
        break
      case 'delete':
        sql = await generateDeleteSql(table.tableName)
        break
      default:
        throw new Error(`Êú™Áü•ÁöÑ SQL ÂëΩ‰ª§Ôºö${command}`)
    }
    
    if (sql) {
      emit('sql-generated', sql)
      ElMessage.success(`Â∑≤ÁîüÊàê ${getCommandDisplayName(command)} ËØ≠Âè•`)
    } else {
      throw new Error('ÁîüÊàêÁöÑ SQL ‰∏∫Á©∫')
    }
  } catch (error: any) {
    console.error('SQL generation error:', error)
    ElMessage.error('ÁîüÊàê SQL Â§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'))
  }
}

// Ëé∑ÂèñÂëΩ‰ª§ÊòæÁ§∫ÂêçÁß∞
const getCommandDisplayName = (command: string): string => {
  const names: Record<string, string> = {
    'select': 'SELECT Êü•ËØ¢',
    'count': 'COUNT Êü•ËØ¢', 
    'describe': 'Ë°®ÁªìÊûÑ',
    'insert': 'INSERT Ê®°Êùø',
    'update': 'UPDATE Ê®°Êùø',
    'delete': 'DELETE Ê®°Êùø'
  }
  return names[command] || command.toUpperCase()
}

// Ëé∑Âèñ‰∏ªÈîÆÂàóÂêç
const getPrimaryKeyColumn = async (tableName: string): Promise<string> => {
  try {
    const columns = await getTableColumnsApi(props.connectionId, tableName, props.schema)
    const pkColumn = columns.find((col: any) => col.isPrimaryKey)
    return pkColumn?.columnName || 'id'
  } catch (error) {
    return 'id'
  }
}

// ÊòæÁ§∫ SQL ËèúÂçï
const showSqlMenuHandler = (event: Event, table: TableInfo) => {
  if (!table || !table.tableName) {
    console.error('Invalid table data for SQL menu:', table)
    ElMessage.error('Ë°®Êï∞ÊçÆÊó†Êïà')
    return
  }
  
  const target = event.target as HTMLElement
  const rect = target.getBoundingClientRect()
  
  sqlMenuStyle.value = {
    left: rect.left + 'px',
    top: (rect.bottom + 5) + 'px'
  }
  sqlMenuTable.value = table
  showSqlMenu.value = true
}

// ÈöêËóè SQL ËèúÂçï
const hideSqlMenu = () => {
  showSqlMenu.value = false
  sqlMenuTable.value = null
}

// Â§ÑÁêÜË°åÂè≥ÈîÆËèúÂçï
const handleRowContextMenu = (event: MouseEvent, table: TableInfo) => {
  if (!table || !table.tableName) {
    console.error('Invalid table data for context menu:', table)
    ElMessage.error('Ë°®Êï∞ÊçÆÊó†Êïà')
    return
  }
  
  // ÂÖàÂÖ≥Èó≠Áé∞ÊúâÁöÑËèúÂçï
  hideContextMenu()
  
  // ‰ΩøÁî® nextTick Á°Æ‰øùËèúÂçïÂÆåÂÖ®ÂÖ≥Èó≠ÂêéÂÜçÊâìÂºÄÊñ∞ËèúÂçï
  nextTick(() => {
    const { clientX, clientY } = event
    
    // Ë∞ÉÊï¥ËèúÂçï‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çË∂ÖÂá∫Â±èÂπïËæπÁïå
    const menuWidth = 180
    const menuHeight = 240
    const windowWidth = window.innerWidth
    const windowHeight = window.innerHeight
    
    let left = clientX
    let top = clientY
    
    if (left + menuWidth > windowWidth) {
      left = windowWidth - menuWidth - 10
    }
    
    if (top + menuHeight > windowHeight) {
      top = windowHeight - menuHeight - 10
    }
    
    contextMenuStyle.value = {
      left: `${left}px`,
      top: `${top}px`
    }
    
    contextMenuTable.value = table
    showContextMenu.value = true
  })
}

// ÈöêËóèÂè≥ÈîÆËèúÂçï
const hideContextMenu = () => {
  showContextMenu.value = false
  contextMenuTable.value = null
}

// Â§ÑÁêÜÂè≥ÈîÆËèúÂçïÂëΩ‰ª§
const handleContextMenuCommand = async (command: string) => {
  if (!contextMenuTable.value) {
    ElMessage.error('Êú™ÈÄâÊã©Ë°®ÔºåËØ∑ÈáçÊñ∞Âè≥ÈîÆÁÇπÂáª')
    return
  }
  
  // Á´ãÂç≥‰øùÂ≠òË°®Ê†ºÂºïÁî®ÔºåÈÅøÂÖçÂºÇÊ≠•Êìç‰Ωú‰∏≠‰∏¢Â§±
  const tableRef = { ...contextMenuTable.value }
  
  // ÈöêËóèËèúÂçï
  hideContextMenu()
  
  try {
    if (command === 'viewFields') {
      await handleViewFields(tableRef)
    } else {
      await handleSqlCommand(command, tableRef)
    }
  } catch (error: any) {
    console.error('Command execution failed:', error)
    ElMessage.error('Êìç‰ΩúÂ§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'))
  }
}

// Â§ÑÁêÜ SQL ËèúÂçïÂëΩ‰ª§
const handleSqlMenuCommand = async (command: string) => {
  if (!sqlMenuTable.value) {
    ElMessage.error('Êú™ÈÄâÊã©Ë°®ÔºåËØ∑ÈáçÊñ∞ÁÇπÂáª SQL ÊåâÈíÆ')
    return
  }
  
  // ÂÖà‰øùÂ≠òË°®Ê†ºÂºïÁî®ÔºåÂÜçÈöêËóèËèúÂçï
  const tableRef = { ...sqlMenuTable.value }
  hideSqlMenu()
  await handleSqlCommand(command, tableRef)
}

// Ëé∑ÂèñË°åÊ†∑ÂºèÁ±ª - ÁßªÈô§ÈÄâ‰∏≠Áä∂ÊÄÅÂà§Êñ≠
const getRowClass = ({ rowData }: any) => {
  return 'table-row'
}

// Â§çÂà∂Â≠óÊÆµÂêç
const copyFieldName = async (fieldName: string) => {
  try {
    await navigator.clipboard.writeText(fieldName)
    ElMessage.success(`Â∑≤Â§çÂà∂Â≠óÊÆµÂêçÔºö${fieldName}`)
  } catch (error) {
    // ÈôçÁ∫ßÊñπÊ°à
    const textArea = document.createElement('textarea')
    textArea.value = fieldName
    document.body.appendChild(textArea)
    textArea.select()
    document.execCommand('copy')
    document.body.removeChild(textArea)
    ElMessage.success(`Â∑≤Â§çÂà∂Â≠óÊÆµÂêçÔºö${fieldName}`)
  }
}

// Â§çÂà∂ÊâÄÊúâÂ≠óÊÆµÂêç
const copyAllFields = async () => {
  try {
    const fieldNames = filteredFields.value.map(field => field.columnName).join(', ')
    await navigator.clipboard.writeText(fieldNames)
    ElMessage.success(`Â∑≤Â§çÂà∂ ${filteredFields.value.length} ‰∏™Â≠óÊÆµÂêç`)
  } catch (error) {
    // ÈôçÁ∫ßÊñπÊ°à
    const fieldNames = filteredFields.value.map(field => field.columnName).join(', ')
    const textArea = document.createElement('textarea')
    textArea.value = fieldNames
    document.body.appendChild(textArea)
    textArea.select()
    document.execCommand('copy')
    document.body.removeChild(textArea)
    ElMessage.success(`Â∑≤Â§çÂà∂ ${filteredFields.value.length} ‰∏™Â≠óÊÆµÂêç`)
  }
}

// ÈáçÁΩÆÂ≠óÊÆµÊêúÁ¥¢
const resetFieldSearch = () => {
  fieldSearchText.value = ''
}

// ÁõëÂê¨Â≠óÊÆµÂºπÊ°ÜÂÖ≥Èó≠ÔºåÈáçÁΩÆÊêúÁ¥¢
watch(showFieldDialog, (newVal) => {
  if (!newVal) {
    resetFieldSearch()
  }
})

// ÈáçÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
const resetLoadingState = () => {
  loadingProgress.value = 0
  loadingStage.value = ''
  loadingDetails.value = ''
  showDetailedProgress.value = false
  estimatedTotal.value = 0
  loadedCount.value = 0
}

// Êõ¥Êñ∞Âä†ËΩΩËøõÂ∫¶
const updateLoadingProgress = (stage: string, details: string, loaded: number = 0, total: number = 0) => {
  loadingStage.value = stage
  loadingDetails.value = details
  loadedCount.value = loaded
  if (total > 0) {
    estimatedTotal.value = total
    loadingProgress.value = Math.round((loaded / total) * 100)
  }
  
  // ÂΩìÂºÄÂßãÊòæÁ§∫ËØ¶ÁªÜËøõÂ∫¶Êó∂ÔºåÂêØÁî®ËØ¶ÁªÜËøõÂ∫¶ÊòæÁ§∫
  if (stage && details) {
    showDetailedProgress.value = true
  }
}

// ‰ºòÂåñÂêéÁöÑÂø´ÈÄüÂä†ËΩΩÊñπÊ≥ï - ‰ΩøÁî®ÂàÜÂ±ÇÂä†ËΩΩÁ≠ñÁï•
const loadTables = async (useCache = true) => {
  if (!props.connectionId) return

  // ÈáçÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
  resetLoadingState()

  // Â¶ÇÊûúÂÖÅËÆ∏‰ΩøÁî®ÁºìÂ≠ò‰∏îÊúâÁºìÂ≠òÔºåÁõ¥Êé•‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
  if (useCache) {
    const cachedTables = tableCacheManager.getCachedTables(props.connectionId, props.schema)
    if (cachedTables) {
      updateLoadingProgress('Âä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ', '‰ªéÊú¨Âú∞ÁºìÂ≠òÂø´ÈÄüÂä†ËΩΩË°®‰ø°ÊÅØ...')
      
      // Á®çÂæÆÂª∂Ëøü‰ª•ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      await new Promise(resolve => setTimeout(resolve, 100))
      
      tableData.value = cachedTables
      cacheMetadata.value = tableCacheManager.getCacheMetadata(props.connectionId, props.schema)
      applySearch()
      return
    }
  }

  loading.value = true

  try {
    updateLoadingProgress('ÂàùÂßãÂåñËøûÊé•', 'Ê≠£Âú®ËøûÊé•Êï∞ÊçÆÂ∫ìÂπ∂ÂáÜÂ§áËé∑ÂèñË°®ÂàóË°®...')
    
    // ‰ΩøÁî®Âø´ÈÄüAPIÂàÜÊâπÂä†ËΩΩÂü∫Á°ÄË°®‰ø°ÊÅØÔºàÂè™ÂåÖÂê´Ë°®ÂêçÂíåÂ§áÊ≥®Ôºâ
    const allTables: TableInfo[] = []
    let currentPage = 1
    let hasMore = true
    const pageSize = 200 // Â¢ûÂä†È°µÈù¢Â§ßÂ∞èÔºåÂõ†‰∏∫Âè™Ëé∑ÂèñÂü∫Á°Ä‰ø°ÊÅØ

    // ÂÖàËé∑ÂèñÁ¨¨‰∏ÄÈ°µ‰ª•‰∫ÜËß£ÊÄªÊï∞
    updateLoadingProgress('Ëé∑ÂèñË°®ÂàóË°®', 'Ê≠£Âú®Ëé∑ÂèñÊï∞ÊçÆÂ∫ìË°®‰ø°ÊÅØ...')
    
    while (hasMore) {
      const params = {
        page: currentPage,
        size: pageSize,
        sortBy: 'name',
        sortOrder: 'asc',
        schema: props.schema
      }

      updateLoadingProgress(
        'Ëé∑ÂèñË°®ÂàóË°®', 
        `Ê≠£Âú®Ëé∑ÂèñÁ¨¨ ${currentPage} È°µË°®‰ø°ÊÅØ...`,
        allTables.length,
        estimatedTotal.value
      )

      const response = await getBasicTablesWithPaginationApi(props.connectionId, params)
      
      if (response.data && response.data.length > 0) {
        // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÈ°µÔºåËÆæÁΩÆÈ¢Ñ‰º∞ÊÄªÊï∞
        if (currentPage === 1 && response.total) {
          estimatedTotal.value = response.total
        }
        
        // ËΩ¨Êç¢Âü∫Á°ÄÊï∞ÊçÆÊ†ºÂºèÔºåËØ¶ÁªÜ‰ø°ÊÅØËÆæ‰∏∫ÈªòËÆ§ÂÄº
        const tables: TableInfo[] = response.data.map((table: any) => ({
          tableName: table.tableName || table.name,
          tableType: table.tableType || 'TABLE',
          columnCount: 0, // ÈªòËÆ§ÂÄºÔºåÂ∞ÜÂú®ÈúÄË¶ÅÊó∂ÊáíÂä†ËΩΩ
          remarks: table.remarks || table.comment || '',
          hasPrimaryKey: false, // ÈªòËÆ§ÂÄºÔºåÂ∞ÜÂú®ÈúÄË¶ÅÊó∂ÊáíÂä†ËΩΩ
          schema: props.schema,
          connectionId: props.connectionId,
          lastUpdated: Date.now(),
          // Ê∑ªÂä†Ê†áÂøó‰ΩçÔºåË°®Á§∫ËØ¶ÁªÜ‰ø°ÊÅØÂ∞öÊú™Âä†ËΩΩ
          _detailsLoaded: false
        }))
        
        allTables.push(...tables)
        
        // Êõ¥Êñ∞ËøõÂ∫¶
        updateLoadingProgress(
          'Ëé∑ÂèñË°®ÂàóË°®', 
          `Â∑≤Ëé∑Âèñ ${allTables.length} Âº†Ë°®ÁöÑÂü∫Á°Ä‰ø°ÊÅØ...`,
          allTables.length,
          estimatedTotal.value || allTables.length
        )
      }

      hasMore = response.hasNext || false
      currentPage++

      // Èò≤Ê≠¢Êó†ÈôêÂæ™ÁéØ
      if (currentPage > 200) {
        console.warn('Too many pages, stopping table loading')
        break
      }
    }

    updateLoadingProgress('‰øùÂ≠òÁºìÂ≠ò', 'Ê≠£Âú®‰øùÂ≠òË°®‰ø°ÊÅØÂà∞Êú¨Âú∞ÁºìÂ≠ò...', allTables.length, allTables.length)
    
    // ÁºìÂ≠òÂü∫Á°ÄÊï∞ÊçÆ
    tableCacheManager.cacheTables(props.connectionId, props.schema, allTables)
    
    tableData.value = allTables
    cacheMetadata.value = tableCacheManager.getCacheMetadata(props.connectionId, props.schema)
    
    applySearch()
    
    ElMessage.success(`Âø´ÈÄüÂä†ËΩΩ ${allTables.length} Âº†Ë°®ÔºàÂü∫Á°Ä‰ø°ÊÅØÔºâ`)
    
    // ÂºÇÊ≠•ÊâπÈáèÂä†ËΩΩÂèØËßÅË°®ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
    setTimeout(() => {
      loadVisibleTableDetails()
    }, 500) // Âª∂Ëøü500msÂºÄÂßãÂä†ËΩΩËØ¶ÁªÜ‰ø°ÊÅØ
    
  } catch (error: any) {
    console.error('Âä†ËΩΩË°®ÂàóË°®Â§±Ë¥•Ôºö', error)
    
    // ÂõûÈÄÄÂà∞ÊóßÁöÑAPI
    try {
      updateLoadingProgress('Â∞ùËØï‰º†ÁªüÊñπÂºè', 'Âø´ÈÄüÂä†ËΩΩÂ§±Ë¥•ÔºåÊ≠£Âú®Â∞ùËØï‰º†ÁªüÂä†ËΩΩÊñπÂºè...')
      ElMessage.warning('Ê≠£Âú®Â∞ùËØï‰º†ÁªüÂä†ËΩΩÊñπÂºè...')
      await loadTablesLegacy(false)
    } catch (fallbackError: any) {
      ElMessage.error('Âä†ËΩΩË°®ÂàóË°®Â§±Ë¥•Ôºö' + (error.message || 'Êú™Áü•ÈîôËØØ'))
    }
  } finally {
    loading.value = false
    resetLoadingState()
  }
}

// ‰º†ÁªüÂä†ËΩΩÊñπÊ≥ïÔºà‰Ωú‰∏∫ÂõûÈÄÄÊñπÊ°àÔºâ
const loadTablesLegacy = async (useCache = true) => {
  if (!props.connectionId) return

  if (useCache) {
    const cachedTables = tableCacheManager.getCachedTables(props.connectionId, props.schema)
    if (cachedTables) {
      tableData.value = cachedTables
      cacheMetadata.value = tableCacheManager.getCacheMetadata(props.connectionId, props.schema)
      applySearch()
      return
    }
  }

  const allTables: TableInfo[] = []
  let currentPage = 1
  let hasMore = true
  const pageSize = 100

  while (hasMore) {
    const params = {
      page: currentPage,
      size: pageSize,
      sortBy: 'name',
      sortOrder: 'asc',
      schema: props.schema
    }

    const response = await getTablesWithPaginationApi(props.connectionId, params)
    
    if (response.data && response.data.length > 0) {
      const tables: TableInfo[] = response.data.map((table: any) => ({
        tableName: table.tableName || table.name,
        tableType: table.tableType || 'TABLE',
        columnCount: table.columnCount || 0,
        remarks: table.remarks || table.comment,
        hasPrimaryKey: table.hasPrimaryKey || false,
        schema: props.schema,
        connectionId: props.connectionId,
        lastUpdated: Date.now(),
        _detailsLoaded: true
      }))
      
      allTables.push(...tables)
    }

    hasMore = response.hasNext || false
    currentPage++

    if (currentPage > 100) {
      console.warn('Too many pages, stopping table loading')
      break
    }
  }

  tableCacheManager.cacheTables(props.connectionId, props.schema, allTables)
  tableData.value = allTables
  cacheMetadata.value = tableCacheManager.getCacheMetadata(props.connectionId, props.schema)
  applySearch()
  
  ElMessage.success(`ÊàêÂäüÂä†ËΩΩ ${allTables.length} Âº†Ë°®ÔºàÂÆåÊï¥‰ø°ÊÅØÔºâ`)
}

// ÊáíÂä†ËΩΩÂèØËßÅË°®ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
const loadVisibleTableDetails = async () => {
  try {
    // Ëé∑ÂèñÂâç50‰∏™Ë°®ÁöÑËØ¶ÁªÜ‰ø°ÊÅØÔºàËøô‰∫õÈÄöÂ∏∏ÊòØÁî®Êà∑ÊúÄÂÖ≥ÂøÉÁöÑÔºâ
    const tablesToLoad = filteredData.value.slice(0, 50).filter(table => !table._detailsLoaded)
    
    if (tablesToLoad.length === 0) return
    
    // ÊâπÈáèËé∑ÂèñË°®ÁªüËÆ°‰ø°ÊÅØ
    const tableNames = tablesToLoad.map(table => table.tableName)
    const stats = await getBatchTableStatsApi(props.connectionId, {
      tableNames,
      schema: props.schema
    })
    
    // Êõ¥Êñ∞Ë°®‰ø°ÊÅØ
    tablesToLoad.forEach(table => {
      const stat = stats[table.tableName]
      if (stat && !stat.error) {
        table.columnCount = stat.columnCount || 0
        table.hasPrimaryKey = stat.hasPrimaryKey || false
        table._detailsLoaded = true
      }
    })
    
    // Êõ¥Êñ∞ÁºìÂ≠ò
    tableCacheManager.cacheTables(props.connectionId, props.schema, tableData.value)
    
    // Ëß¶ÂèëË°®Ê†ºÊõ¥Êñ∞
    tableKey.value++
    
  } catch (error: any) {
    console.warn('ÊâπÈáèÂä†ËΩΩË°®ËØ¶ÁªÜ‰ø°ÊÅØÂ§±Ë¥•Ôºö', error)
    // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÂü∫Á°ÄÂäüËÉΩ
  }
}

// Ëé∑ÂèñÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ
const loadConnectionInfo = async () => {
  try {
    if (!connectionInfo.value) {
      const result = await getConnectionByIdApi(props.connectionId)
      connectionInfo.value = result
      dbType.value = result.dbType || 'mysql'
    }
  } catch (error: any) {
    console.warn('Ëé∑ÂèñÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØÂ§±Ë¥•Ôºö', error)
    // ÈªòËÆ§‰ΩøÁî®MySQLËØ≠Ê≥ï
    dbType.value = 'mysql'
  }
}

const refreshTables = async () => {
  refreshing.value = true
  try {
    // Ê∏ÖÈô§ÁºìÂ≠òÂπ∂ÈáçÊñ∞Âä†ËΩΩ
    tableCacheManager.clearCache(props.connectionId, props.schema)
    await loadTables(false)
  } finally {
    refreshing.value = false
  }
}

const applySearch = () => {
  if (!searchText.value.trim()) {
    filteredData.value = tableData.value
    return
  }

  const searchLower = searchText.value.toLowerCase()
  filteredData.value = tableData.value.filter(table => 
    table.tableName.toLowerCase().includes(searchLower) ||
    (table.remarks && table.remarks.toLowerCase().includes(searchLower))
  )
}

const handleSearch = () => {
  // Èò≤ÊäñÂ§ÑÁêÜ
  clearTimeout(searchTimeout.value)
  searchTimeout.value = setTimeout(() => {
    applySearch()
  }, 300)
}

const generateSelectSql = async (tableName: string) => {
  try {
    // Á°Æ‰øùÂ∑≤Âä†ËΩΩÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ
    await loadConnectionInfo()
    
    const columns = await getTableColumnsApi(props.connectionId, tableName, props.schema)
    // Â¶ÇÊûúÂ≠óÊÆµÊï∞ÈáèËæÉÂ§öÔºåÂè™ÈÄâÊã©Ââç 10 ‰∏™Â≠óÊÆµÔºõÂê¶Âàô‰ΩøÁî®ÊâÄÊúâÂ≠óÊÆµ
    const columnNames = columns.length > 10 
      ? columns.slice(0, 10).map((col: any) => col.columnName)
      : columns.map((col: any) => col.columnName)
      
    return generateSelectQuery(dbType.value, tableName, columnNames, props.schema)
  } catch (error) {
    // Á°Æ‰øùÊúâÈªòËÆ§ÁöÑÊï∞ÊçÆÂ∫ìÁ±ªÂûã
    await loadConnectionInfo()
    return generateSelectQuery(dbType.value, tableName, [], props.schema)
  }
}

const generateInsertSql = async (tableName: string) => {
  try {
    // Á°Æ‰øùÂ∑≤Âä†ËΩΩÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ
    await loadConnectionInfo()
    
    const columns = await getTableColumnsApi(props.connectionId, tableName, props.schema)
    // ËøáÊª§ÊéâËá™Â¢ûÂ≠óÊÆµÔºåÊûÑÂª∫Âàó‰ø°ÊÅØ
    const insertColumns = columns
      .filter((col: any) => !col.isAutoIncrement)
      .map((col: any) => ({
        columnName: col.columnName,
        dataType: col.dataType || 'VARCHAR',
        nullable: col.nullable !== false
      }))
      
    return generateInsertQuery(dbType.value, tableName, insertColumns, props.schema)
  } catch (error) {
    await loadConnectionInfo()
    return generateInsertQuery(dbType.value, tableName, [], props.schema)
  }
}

const generateUpdateSql = async (tableName: string) => {
  try {
    // Á°Æ‰øùÂ∑≤Âä†ËΩΩÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ
    await loadConnectionInfo()
    
    const columns = await getTableColumnsApi(props.connectionId, tableName, props.schema)
    // ÊûÑÂª∫Âàó‰ø°ÊÅØÔºåÂåÖÂê´‰∏ªÈîÆÊ†áËØÜ
    const updateColumns = columns.map((col: any) => ({
      columnName: col.columnName,
      dataType: col.dataType || 'VARCHAR',
      isPrimaryKey: col.isPrimaryKey === true
    }))
      
    return generateUpdateQuery(dbType.value, tableName, updateColumns, props.schema)
  } catch (error) {
    await loadConnectionInfo()
    return generateUpdateQuery(dbType.value, tableName, [], props.schema)
  }
}

const generateDeleteSql = async (tableName: string) => {
  try {
    // Á°Æ‰øùÂ∑≤Âä†ËΩΩÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ
    await loadConnectionInfo()
    
    const columns = await getTableColumnsApi(props.connectionId, tableName, props.schema)
    // Ëé∑Âèñ‰∏ªÈîÆÂ≠óÊÆµ
    const primaryKeys = columns
      .filter((col: any) => col.isPrimaryKey === true)
      .map((col: any) => ({
        columnName: col.columnName,
        dataType: col.dataType || 'VARCHAR'
      }))
      
    return generateDeleteQuery(dbType.value, tableName, primaryKeys, props.schema)
  } catch (error) {
    await loadConnectionInfo()
    return generateDeleteQuery(dbType.value, tableName, [], props.schema)
  }
}

const generateDescribeSql = async (tableName: string) => {
  try {
    // Á°Æ‰øùÂ∑≤Âä†ËΩΩÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ
    await loadConnectionInfo()
    
    return generateDescribeQuery(dbType.value, tableName, props.schema)
  } catch (error) {
    await loadConnectionInfo()
    return generateDescribeQuery(dbType.value, tableName, props.schema)
  }
}

const getEmptyDescription = () => {
  if (loading.value) return 'Âä†ËΩΩ‰∏≠...'
  if (searchText.value) return 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË°®'
  if (!hasCache.value) return 'ÊöÇÊó†Ë°®Êï∞ÊçÆÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂä†ËΩΩ'
  return 'ÊöÇÊó†Êï∞ÊçÆ'
}

const formatTime = (timestamp: number) => {
  return new Date(timestamp).toLocaleString()
}

// ÁõëÂê¨Âô®
watch(() => props.connectionId, () => {
  if (props.connectionId) {
    loadTables(true)
  }
}, { immediate: true })

watch(() => props.schema, () => {
  if (props.connectionId) {
    loadTables(true)
  }
})

// ÂÖ®Â±ÄÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜÂô®
const handleGlobalClick = (e: MouseEvent) => {
  const target = e.target as Element
  
  // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÂè≥ÈîÆËèúÂçïÔºåÂàôÈöêËóèËèúÂçï
  if (showContextMenu.value) {
    const contextMenuEl = document.querySelector('.context-menu')
    const overlayEl = document.querySelector('.context-menu-overlay')
    
    if (contextMenuEl && !contextMenuEl.contains(target) && 
        overlayEl && !overlayEl.contains(target)) {
      hideContextMenu()
    }
  }
  
  if (showSqlMenu.value) {
    const sqlMenuEl = document.querySelector('.sql-menu')
    const overlayEl = document.querySelector('.sql-menu-overlay')
    
    // ‰∏çÈöêËóè SQL ËèúÂçïÔºåÂ¶ÇÊûúÁÇπÂáªÁöÑÊòØ SQL ÊåâÈíÆÊàñÂÖ∂Â≠êÂÖÉÁ¥†
    const isSqlButton = target.closest('.action-buttons') !== null
    
    if (!isSqlButton && sqlMenuEl && !sqlMenuEl.contains(target) && 
        overlayEl && !overlayEl.contains(target)) {
      hideSqlMenu()
    }
  }
}

// ÁîüÂëΩÂë®Êúü
onMounted(() => {
  if (props.connectionId) {
    loadConnectionInfo() // ÂÖàÂä†ËΩΩËøûÊé•‰ø°ÊÅØ
    loadTables(true)
  }
  
  // Âª∂ËøüÊ∑ªÂä†ÂÖ®Â±ÄÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈÅøÂÖç‰∏éÂàùÂßãÂåñÁÇπÂáªÂÜ≤Á™Å
  setTimeout(() => {
    document.addEventListener('click', handleGlobalClick)
    document.addEventListener('contextmenu', (e) => {
      // Â¶ÇÊûúÂè≥ÈîÆËèúÂçïÂ∑≤ÊòæÁ§∫ÔºåÈòªÊ≠¢ÈªòËÆ§ÁöÑÊµèËßàÂô®Âè≥ÈîÆËèúÂçï
      if (showContextMenu.value) {
        e.preventDefault()
      }
    })
  }, 100)
})

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
onUnmounted(() => {
  document.removeEventListener('click', handleGlobalClick)
})
</script>

<style scoped>
.cached-table-list {
  height: 100%;
  display: flex;
  flex-direction: column;
  position: relative;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--el-border-color-light);
  background: var(--el-bg-color-page);
}

.toolbar-left {
  flex: 1;
  max-width: 300px;
}

.toolbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.search-input {
  width: 100%;
}

.cache-status {
  cursor: help;
}

.cache-info {
  padding: 8px 16px;
  background: var(--el-fill-color-lighter);
  border-bottom: 1px solid var(--el-border-color-light);
}

.table-container {
  flex: 1;
  min-height: 400px;
  position: relative;
}

.virtual-table {
  border: 1px solid var(--el-border-color-lighter);
  border-radius: 8px;
  overflow: hidden;
}

/* Ë°®Ê†ºË°åÁªü‰∏ÄÊ†∑Âºè */
.table-row-cell {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 12px 0;
  border-radius: 8px;
  transition: all 0.2s ease;
  cursor: context-menu;
  height: 100%;
  min-height: 68px;
  box-sizing: border-box;
}

/* Á°Æ‰øùÊï¥Ë°åÂå∫ÂüüÈÉΩËÉΩÂìçÂ∫îÂè≥ÈîÆ‰∫ã‰ª∂ */
.full-width-cell {
  width: 100% !important;
  position: relative;
  display: flex;
  align-items: center;
}

.table-row-cell:hover {
  background-color: var(--el-fill-color-light);
  transform: translateX(2px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

/* Ë°®Ê†ºÂÜÖÂÆπÊ†∑Âºè */
.table-name-content {
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 6px;
  flex: 1;
  min-width: 0;
  height: 100%;
}

.table-name {
  font-weight: 600;
  font-size: 15px;
  color: var(--el-text-color-primary);
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.table-row-cell:hover .table-name {
  color: var(--el-color-primary);
}

.table-meta-tags {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 2px;
}

.table-type-tag {
  font-weight: 500;
  font-size: 12px;
  height: 20px;
  padding: 0 6px;
}

.column-count {
  font-size: 12px;
  color: var(--el-text-color-secondary);
  font-weight: 500;
  white-space: nowrap;
}

.pk-tag {
  font-weight: 600;
  font-size: 11px;
  height: 18px;
  padding: 0 5px;
}

.table-remarks-cell {
  padding: 12px 0;
  height: 100%;
  min-height: 68px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  box-sizing: border-box;
}

.table-remarks {
  color: var(--el-text-color-secondary);
  font-size: 14px;
  line-height: 1.4;
  display: block;
}

/* Tooltip Ê†∑Âºè‰ºòÂåñ */
.tooltip-content {
  padding: 8px 0;
}

.tooltip-item {
  display: flex;
  align-items: center;
  margin: 4px 0;
  font-size: 13px;
  line-height: 1.4;
}

.tooltip-label {
  color: var(--el-text-color-secondary);
  min-width: 40px;
  font-weight: 500;
}

.tooltip-value {
  color: var(--el-text-color-primary);
  font-weight: 400;
}

/* Âè≥ÈîÆËèúÂçïÊ†∑Âºè */
.context-menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  background: transparent;
}

.context-menu {
  position: fixed;
  z-index: 10000;
  background: var(--el-bg-color-overlay);
  border: 1px solid var(--el-border-color-light);
  border-radius: 8px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  padding: 6px 0;
  min-width: 180px;
  backdrop-filter: blur(10px);
  animation: contextMenuFadeIn 0.15s ease-out;
}

@keyframes contextMenuFadeIn {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(-5px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.context-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  cursor: pointer;
  font-size: 14px;
  color: var(--el-text-color-primary);
  transition: all 0.15s ease;
  user-select: none;
}

.context-menu-item:hover {
  background-color: var(--el-color-primary-light-9);
  color: var(--el-color-primary);
}

.context-menu-item .el-icon {
  font-size: 16px;
  color: var(--el-text-color-secondary);
  flex-shrink: 0;
}

.context-menu-item:hover .el-icon {
  color: var(--el-color-primary);
}

.context-menu-divider {
  height: 1px;
  background-color: var(--el-border-color-lighter);
  margin: 6px 0;
}

/* SQL ËèúÂçïÊ†∑Âºè */
.sql-menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9998;
  background: transparent;
}

.sql-menu {
  position: fixed;
  z-index: 9999;
  background: var(--el-bg-color-overlay);
  border: 1px solid var(--el-border-color-light);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 4px 0;
  min-width: 160px;
  backdrop-filter: blur(8px);
}

.sql-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 14px;
  color: var(--el-text-color-primary);
  transition: all 0.2s ease;
}

.sql-menu-item:hover {
  background-color: var(--el-color-primary-light-9);
  color: var(--el-color-primary);
}

.sql-menu-item .el-icon {
  font-size: 16px;
  color: var(--el-text-color-secondary);
}

.sql-menu-item:hover .el-icon {
  color: var(--el-color-primary);
}

.sql-menu-divider {
  height: 1px;
  background-color: var(--el-border-color-lighter);
  margin: 4px 0;
}

/* Â≠óÊÆµÂºπÊ°ÜÊ†∑Âºè */
.field-dialog {
  --el-dialog-border-radius: 12px;
}

.field-dialog-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding: 0 4px;
}

.field-search {
  width: 300px;
}

.field-stats {
  display: flex;
  align-items: center;
  gap: 8px;
}

.field-dialog-content {
  max-height: 500px;
  border-radius: 8px;
  overflow: hidden;
}

.field-table {
  --el-table-border-radius: 8px;
}

.field-name-cell {
  display: flex;
  align-items: center;
  gap: 8px;
  position: relative;
}

.pk-icon {
  color: var(--el-color-warning);
  font-size: 14px;
}

.field-name {
  font-weight: 500;
  flex: 1;
}

.field-name.is-primary {
  color: var(--el-color-warning);
  font-weight: 600;
}

.copy-btn {
  opacity: 0;
  transition: opacity 0.2s ease;
  padding: 4px;
  margin-left: auto;
}

.field-name-cell:hover .copy-btn {
  opacity: 1;
}

.type-tag {
  font-family: 'Consolas', 'Monaco', monospace;
  font-weight: 500;
}

.field-remarks {
  color: var(--el-text-color-secondary);
  font-size: 13px;
}

.dialog-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Â≠óÊÆµË°®Ê†ºË°å hover ÊïàÊûú */
:global(.field-table .el-table__row:hover) {
  background-color: var(--el-fill-color-light) !important;
}

/* ‰∏ªÈîÆË°åÁâπÊÆäÊ†∑Âºè */
:global(.field-table .el-table__row:has(.is-primary)) {
  background-color: var(--el-color-warning-light-9) !important;
}

:global(.field-table .el-table__row:has(.is-primary):hover) {
  background-color: var(--el-color-warning-light-8) !important;
}

/* ÂÖ®Â±Ä tooltip Ê†∑Âºè */
:global(.table-info-tooltip) {
  max-width: 200px;
}

:global(.table-info-tooltip .el-popper__arrow::before) {
  background: var(--el-bg-color-overlay);
  border: 1px solid var(--el-border-color-light);
}

/* Ë°®Ê†ºË°å hover ÊïàÊûú */
:global(.el-table-v2__row:hover) {
  background-color: var(--el-fill-color-lighter) !important;
}

/* Ë°®Ê†ºË°åÊ†∑Âºè */
:global(.table-row) {
  transition: all 0.2s ease;
}

:global(.table-row:hover) {
  background-color: var(--el-fill-color-lighter) !important;
}

/* Á°Æ‰øùË°®Ê†ºÂçïÂÖÉÊ†ºÂ°´Êª°Êï¥‰∏™ÂèØÁî®Á©∫Èó¥ */
:global(.el-table-v2__row-cell) {
  padding: 0 16px !important;
  display: flex;
  align-items: center;
}

:global(.el-table-v2__row-cell > *) {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
}

/* Ë°®Ê†ºÂ§¥ÈÉ®Ê†∑Âºè‰ºòÂåñ */
:global(.el-table-v2__header-row) {
  background-color: var(--el-fill-color-light);
  font-weight: 600;
  color: var(--el-text-color-primary);
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.loading-content {
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
}

.detailed-loading {
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  padding: 32px;
  text-align: center;
  border: 1px solid var(--el-border-color-lighter);
}

.loading-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.loading-icon {
  color: var(--el-color-primary);
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--el-text-color-primary);
  margin: 0;
  line-height: 1.3;
}

.loading-body {
  margin-bottom: 24px;
}

.loading-details {
  color: var(--el-text-color-secondary);
  font-size: 14px;
  margin: 16px 0;
  line-height: 1.5;
}

.loading-stats {
  display: flex;
  justify-content: center;
  gap: 8px;
  font-size: 13px;
  color: var(--el-text-color-regular);
  margin-top: 12px;
}

.loading-stats span {
  padding: 4px 8px;
  background: var(--el-fill-color-light);
  border-radius: 4px;
  font-weight: 500;
}

.progress-text {
  font-weight: 600;
  color: var(--el-color-primary);
}

.loading-tips {
  padding: 16px;
  background: var(--el-fill-color-lighter);
  border-radius: 8px;
  border-left: 4px solid var(--el-color-primary);
}

/* ËøõÂ∫¶Êù°Ê†∑Âºè‰ºòÂåñ */
:global(.el-progress__text) {
  font-weight: 600 !important;
}

:global(.el-progress-bar__outer) {
  background-color: var(--el-fill-color-light) !important;
}

:global(.el-progress-bar__inner) {
  background: linear-gradient(90deg, var(--el-color-primary), var(--el-color-primary-light-3)) !important;
}

.empty-actions {
  margin-top: 16px;
}

/* ÂìçÂ∫îÂºè‰ºòÂåñ */
@media (max-width: 768px) {
  .table-row-cell {
    padding: 10px 12px;
  }
  
  .table-name {
    font-size: 14px;
  }
  
  .table-name-content {
    gap: 4px;
  }
  
  .table-meta-tags {
    gap: 6px;
  }
  
  .table-type-tag {
    font-size: 11px;
    height: 18px;
    padding: 0 5px;
  }
  
  .column-count {
    font-size: 11px;
  }
  
  .pk-tag {
    font-size: 10px;
    height: 16px;
    padding: 0 4px;
  }
  
  .table-remarks {
    font-size: 13px;
  }
  
  .context-menu {
    min-width: 160px;
  }
  
  .context-menu-item {
    padding: 10px 16px;
    font-size: 16px;
  }
  
  .sql-menu {
    min-width: 160px;
  }
  
  .sql-menu-item {
    padding: 10px 16px;
    font-size: 16px;
  }
}
</style>
